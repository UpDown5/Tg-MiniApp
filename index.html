<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Casino Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS для использования темы Telegram */
        :root {
            --bg-color: #f0f0f0;
            --text-color: #000000;
            --secondary-bg-color: #ffffff;
            --button-color: #55acee;
            --button-text-color: #ffffff;
            --hint-color: #999999;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Применение темы Telegram */
        body.tg-theme {
            --bg-color: var(--tg-theme-bg-color);
            --text-color: var(--tg-theme-text-color);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color);
            --button-color: var(--tg-theme-button-color);
            --button-text-color: var(--tg-theme-button-text-color);
            --hint-color: var(--tg-theme-hint-color);
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--secondary-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--button-color);
        }

        .balance {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--hint-color);
            border-radius: 8px;
        }

        .controls {
            margin-bottom: 20px;
        }

        .controls input, .controls button {
            padding: 10px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid var(--hint-color);
        }

        .controls button {
            background-color: var(--button-color);
            color: var(--button-text-color);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .controls button:hover:not(:disabled) {
            filter: brightness(1.1);
        }
        
        .controls button:disabled {
            background-color: var(--hint-color);
            cursor: not-allowed;
        }

        /* Стиль для колеса фортуны */
        .wheel {
            width: 250px;
            height: 250px;
            background: conic-gradient(
                #ffcc00 0% 25%, 
                #4CAF50 25% 50%, 
                #f44336 50% 75%, 
                #2196F3 75% 100%
            );
            border-radius: 50%;
            margin: 20px auto;
            border: 10px solid var(--button-color);
            position: relative;
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 15px solid var(--text-color);
        }

        .result {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
        }
    </style>
</head>
<body class="tg-theme">
    <div class="container">
        <h1>Колесо Удачи!</h1>
        <div class="balance">
            Ваш баланс: <span id="userBalance">1000</span> (тест)
        </div>

        <div class="controls">
            <input type="number" id="betInput" value="10" min="1" placeholder="Ваша ставка">
            <button id="spinButton">Вращать Колесо</button>
        </div>

        <div class="wheel" id="wheel">
            <div class="pointer"></div>
            </div>

        <div class="result" id="gameResult">
            Нажмите "Вращать Колесо", чтобы начать.
        </div>
        
        <p style="font-size: 0.8em; color: var(--hint-color);">
            *Это демонстрационный код. Для реального казино необходим защищенный бэкенд и Provably Fair система.
        </p>
    </div>

    <script>
        const WebApp = window.Telegram.WebApp;
        const userBalanceElem = document.getElementById('userBalance');
        const betInput = document.getElementById('betInput');
        const spinButton = document.getElementById('spinButton');
        const wheel = document.getElementById('wheel');
        const gameResult = document.getElementById('gameResult');
        
        let userBalance = 1000;
        let isSpinning = false;
        
        // Секторы колеса: [Название, Множитель, Угол в градусах]
        const sectors = [
            ['x2 (Красный)', 2, 0],
            ['x0.5 (Синий)', 0.5, 90],
            ['x0 (Зеленый)', 0, 180],
            ['x3 (Желтый)', 3, 270]
        ];

        // --- ИНИЦИАЛИЗАЦИЯ TELEGRAM MINI APP ---
        function initTelegram() {
            if (WebApp.initDataUnsafe) {
                // Применяем цветовую схему Telegram
                document.body.classList.add('tg-theme');
                const themeParams = WebApp.themeParams;
                document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color);
                document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color);
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color);
                document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color);
                document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color);

                // Показываем, что приложение готово
                WebApp.ready();
                // Используем MainButton Telegram для дополнительной кнопки (опционально)
                WebApp.MainButton.setText('Пополнить Баланс');
                WebApp.MainButton.onClick(showAlert);
                WebApp.MainButton.show();

                console.log("Mini App запущен для пользователя:", WebApp.initDataUnsafe.user.id);
            } else {
                gameResult.textContent = "Запустите это приложение внутри Telegram!";
            }
        }
        
        function showAlert() {
            // Демонстрация функции Telegram
            WebApp.showAlert('В реальном приложении здесь будет окно пополнения через WebApp.openInvoice или другую платежную систему.');
        }

        // --- ЛОГИКА ИГРЫ ---

        function spinWheel() {
            if (isSpinning) return;
            
            const bet = parseInt(betInput.value);
            
            if (isNaN(bet) || bet <= 0) {
                WebApp.showPopup({ message: "Введите корректную ставку." });
                return;
            }
            if (userBalance < bet) {
                WebApp.showPopup({ message: "Недостаточно средств на балансе!" });
                return;
            }

            // 1. Снимаем ставку (В реальном казино - запрос к БЭКЕНДУ)
            userBalance -= bet;
            userBalanceElem.textContent = userBalance;
            spinButton.disabled = true;
            isSpinning = true;
            gameResult.textContent = 'Вращаем...';

            // 2. Определяем результат (В реальном казино - результат приходит с БЭКЕНДА через Provably Fair)
            const winningSectorIndex = Math.floor(Math.random() * sectors.length); // 0, 1, 2 или 3
            const winningSector = sectors[winningSectorIndex];
            
            // 3. Вычисляем угол поворота
            // Угол до сектора + 3-5 полных оборотов (360 * 3 до 360 * 5) + небольшой сдвиг для реализма
            const baseRotation = 360 * 4; 
            const sectorAngle = winningSector[2]; 
            // -45, так как сектор начинается с 0 градусов, а стрелка указывает в середину 90-градусного сектора
            const targetRotation = baseRotation + (360 - sectorAngle) - 45 + (Math.random() * 80 - 40); // Случайный сдвиг

            // 4. Запуск анимации
            wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
            wheel.style.transform = `rotate(${targetRotation}deg)`;

            // 5. Обработка результата после анимации
            setTimeout(() => {
                const multiplier = winningSector[1];
                const winAmount = bet * multiplier;
                
                // Начисляем выигрыш (В реальном казино - запрос к БЭКЕНДУ)
                userBalance += winAmount;
                userBalanceElem.textContent = userBalance.toFixed(2);

                let message;
                if (multiplier > 1) {
                    message = `🎉 Поздравляем! Вы выиграли ${winAmount.toFixed(2)} (x${multiplier}).`;
                } else if (multiplier === 1) {
                    message = `👍 Ничья. Ваша ставка возвращена.`;
                } else if (multiplier > 0 && multiplier < 1) {
                    message = `📉 Не повезло. Вы потеряли ${(bet - winAmount).toFixed(2)}.`;
                } else {
                    message = `😭 Проигрыш! Выпал 'x0'. Потеряно ${bet}.`;
                }
                
                gameResult.textContent = message;
                spinButton.disabled = false;
                isSpinning = false;
                
                // Сброс стиля, чтобы следующее вращение начиналось корректно
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${targetRotation % 360}deg)`;
            }, 3000); // 3 секунды - длительность анимации
        }

        // События
        spinButton.addEventListener('click', spinWheel);

        // Запуск
        initTelegram();
    </script>
</body>
</html>